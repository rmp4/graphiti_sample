# Graphiti 去重和更新功能使用指南

## 概述

此更新版本的程式碼包含了智能去重和更新機制，能夠避免在 Graphiti 知識圖譜中創建重複的節點，並自動更新現有內容的關聯。

## 新增功能

### 1. 智能去重機制
- **內容雜湊識別**：每個 Episode 都會生成基於標題和內容的唯一雜湊值
- **本地去重**：同一批次處理中會自動移除重複的標題
- **遠端檢查**：在添加前會搜尋 Graphiti 中是否已存在相似內容

### 2. 更新模式選項
- **增量模式** (預設)：只添加新內容，更新現有關聯
- **清除模式**：提醒使用者手動清除資料庫後重新建立

### 3. 詳細統計報告
程式執行完成後會顯示詳細的處理統計：
- 總計處理的 Episodes 數量
- 新增的數量
- 更新/合併的數量
- 跳過的數量

## 使用方法

### 基本執行
```bash
python src/main.py
```

### 設定更新模式
使用環境變數控制處理模式：

**增量模式** (預設)：
```bash
set UPDATE_MODE=incremental
python src/main.py
```

**清除模式**：
```bash
set UPDATE_MODE=clean
python src/main.py
```

### 環境變數設定
確保以下環境變數已正確設定：
```bash
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password
OPENAI_API_KEY=your_openai_api_key
UPDATE_MODE=incremental
```

## 工作流程

1. **解析 HTML 檔案**
   - 讀取 `sample_data/sample.html`
   - 提取標題和內容段落
   - 過濾空內容的 Episodes

2. **本地去重**
   - 檢查同批次中的重複標題
   - 移除重複項目並記錄統計

3. **遠端檢查**
   - 對每個 Episode 搜尋 Graphiti 中的相似內容
   - 判斷是新增還是更新操作

4. **處理 Episodes**
   - 為每個 Episode 生成唯一識別符
   - 呼叫 Graphiti 的 `add_episode` 方法
   - Graphiti 會自動處理重複內容的合併

5. **統計報告**
   - 顯示詳細的處理結果
   - 包含各類操作的數量統計

## 日誌訊息說明

### 正常處理訊息
- `新增 Episode: [標題]` - 添加新的內容
- `發現相似內容，Graphiti 將自動處理合併: [標題]` - 發現重複，將合併
- `跳過本地重複標題: [標題]` - 同批次中的重複項目

### 警告訊息
- `沒有找到任何 Episodes` - HTML 檔案中沒有可提取的內容
- `檢查現有內容時發生錯誤` - 搜尋現有內容時出現問題

### 錯誤訊息
- `處理 Episode '[標題]' 時發生錯誤` - 處理特定 Episode 時出現錯誤
- `請設定 OPENAI_API_KEY 環境變數` - 缺少必要的 API 金鑰

## 最佳實踐

### 1. 定期更新
- 使用增量模式定期更新內容
- Graphiti 會自動處理新舊內容的關聯

### 2. 監控統計
- 注意處理統計中的跳過數量
- 如果跳過數量過高，可能需要檢查資料品質

### 3. 資料庫維護
- 定期使用 Neo4j Browser 查看圖譜結構
- 必要時可使用清除模式重新建立

### 4. 效能優化
- 大批量資料建議分批處理
- 監控 Neo4j 資料庫的效能狀況

## 故障排除

### 常見問題

**Q: 程式顯示 "發現相似內容" 但實際上內容不同？**
A: 調整 `check_existing_episode` 函數中的相似度判斷邏輯。

**Q: 為什麼某些 Episodes 被跳過？**
A: 檢查 HTML 內容是否為空，或是否在同批次中有重複標題。

**Q: 如何確認 Graphiti 是否正確合併了重複內容？**
A: 使用 Neo4j Browser 查看資料庫，或透過搜尋功能驗證。

### 除錯步驟
1. 檢查日誌訊息中的詳細錯誤資訊
2. 確認所有環境變數已正確設定
3. 驗證 Neo4j 資料庫連線狀態
4. 檢查 HTML 檔案格式是否正確

## 進階設定

如需進一步客製化，可以修改以下函數：
- `check_existing_episode()` - 調整相似度檢查邏輯
- `get_content_hash()` - 修改唯一識別符生成方式
- `process_episodes_batch()` - 調整批次處理邏輯

## 版本資訊

此版本包含以下改進：
- ✅ 智能去重機制
- ✅ 批次處理優化
- ✅ 詳細統計報告
- ✅ 多種更新模式
- ✅ 錯誤處理和日誌記錄
- ✅ 唯一識別符生成
